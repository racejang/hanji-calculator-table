<script>
(function(){
  const $  = s => document.querySelector(s);
  const toNum = x => Number(String(x ?? '').replace(/[^\d.-]/g,'')); // 안전가드
  const round1 = x => Math.round((x + Number.EPSILON) * 10) / 10;
  const round4 = x => Math.round((x + Number.EPSILON) * 10000) / 10000;

  const wEl = $('#w'), hEl = $('#h');
  const areaEl = $('#area'), kpis = $('#kpis'), sheetsEl = $('#sheets');
  const basisTBody = $('#tblBasisToMass tbody'), donBasisTBody = $('#tblDonToBasis tbody');
  const basisTitle = $('#basisTitle'), donBasisTitle = $('#donBasisTitle');

  // 초기값
  if (wEl) wEl.value = '63.0';
  if (hEl) hEl.value = '93.0';

  function calc(){
    const w = toNum(wEl?.value), h = toNum(hEl?.value);
    if(!isFinite(w) || !isFinite(h) || w<=0 || h<=0){
      alert('가로/세로를 올바르게 입력');
      return;
    }

    // 제목: 항상 기본 텍스트 사용 (입력칸 삭제했으므로)
    if (basisTitle)    basisTitle.textContent    = '평량(g/㎡) → 질량(g)';
    if (donBasisTitle) donBasisTitle.textContent = '돈(몬메) → 평량(g/㎡)';

    const area = (w*h)/10000;
    if (areaEl)   areaEl.textContent = round4(area).toFixed(4);
    if (sheetsEl) sheetsEl.textContent = '1';
    if (kpis)     kpis.style.display = 'grid';

    // 표 채우기
    if (basisTBody) {
      basisTBody.innerHTML = '';
      for(let bw=5; bw<=80; bw+=5){
        const mass = round1(bw * area);
        basisTBody.insertAdjacentHTML('beforeend', `<tr><td>${bw}</td><td>${mass.toFixed(1)}</td></tr>`);
      }
    }

    if (donBasisTBody) {
      donBasisTBody.innerHTML = '';
      for(let d=1.0; d<=8.5+1e-9; d+=0.5){
        const basis = round1((d * 3.75) / area);
        donBasisTBody.insertAdjacentHTML('beforeend', `<tr><td>${d.toFixed(1)}</td><td>${basis.toFixed(1)}</td></tr>`);
      }
    }
  }

  function exportCSV(){
    const rows = [];
    const w = toNum(wEl?.value), h = toNum(hEl?.value);
    const area = (w*h)/10000;

    // 자동 제목(치수). 제목 줄도 빼고 싶으면 아래 두 줄 삭제
    const autoTitle = `${w} × ${h} cm 환산표`;
    rows.push(`"${autoTitle}"`);

    rows.push(`면적(㎡),${round4(area).toFixed(4)}`);
    rows.push('');

    rows.push('평량(g/㎡),질량(g)');
    document.querySelectorAll('#tblBasisToMass tbody tr').forEach(tr=>{
      const tds = tr.querySelectorAll('td');
      rows.push(`${tds[0].textContent},${tds[1].textContent}`);
    });
    rows.push('');

    rows.push('돈(몬메),평량(g/㎡)');
    document.querySelectorAll('#tblDonToBasis tbody tr').forEach(tr=>{
      const tds = tr.querySelectorAll('td');
      rows.push(`${tds[0].textContent},${tds[1].textContent}`);
    });

    const blob = new Blob(["\uFEFF" + rows.join('\r\n')], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${w}x${h}cm-환산표.csv`;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
  }

  // 이벤트 바인딩
  $('#calc')?.addEventListener('click', calc);
  $('#csv')?.addEventListener('click', exportCSV);
  [wEl, hEl].forEach(el => el?.addEventListener('keydown', e => {
    if(e.key === 'Enter') calc();
  }));

  // 최초 계산
  calc();
})();
</script>
