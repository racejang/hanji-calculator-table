(function(){
  const $  = s=>document.querySelector(s);
  const toNum = x => Number(String(x).replace(/[^\d.-]/g,''));
  const round1 = x => Math.round((x + Number.EPSILON) * 10) / 10;
  const round4 = x => Math.round((x + Number.EPSILON) * 10000) / 10000;

  const wEl = $('#w'), hEl = $('#h'); // titleEl 제거
  const areaEl = $('#area'), kpis = $('#kpis'), sheetsEl = $('#sheets');
  const basisTBody = $('#tblBasisToMass tbody'), donBasisTBody = $('#tblDonToBasis tbody');
  const basisTitle = $('#basisTitle'), donBasisTitle = $('#donBasisTitle');

  wEl.value = '63.0'; 
  hEl.value = '93.0'; 
  // titleEl.value = '63.0 × 93.0 cm 환산표';  // 삭제

  function calc(){
    const w = toNum(wEl.value), h = toNum(hEl.value);
    if(!isFinite(w) || !isFinite(h) || w<=0 || h<=0){ alert('가로/세로를 올바르게 입력'); return; }

    // 표 제목: 입력 타이틀 없이 기본 텍스트만
    basisTitle.textContent   = '평량(g/㎡) → 질량(g)';
    donBasisTitle.textContent= '돈(몬메) → 평량(g/㎡)';

    const area = (w*h)/10000;
    areaEl.textContent = round4(area).toFixed(4);
    sheetsEl.textContent = '1';
    kpis.style.display = 'grid';

    // 평량 → 질량
    basisTBody.innerHTML = '';
    for(let bw=5; bw<=80; bw+=5){
      const mass = round1(bw * area);
      basisTBody.insertAdjacentHTML('beforeend', `<tr><td>${bw}</td><td>${mass.toFixed(1)}</td></tr>`);
    }

    // 돈 → 평량
    donBasisTBody.innerHTML = '';
    for(let d=1.0; d<=8.5+1e-9; d+=0.5){
      const basis = round1((d * 3.75) / area);
      donBasisTBody.insertAdjacentHTML('beforeend', `<tr><td>${d.toFixed(1)}</td><td>${basis.toFixed(1)}</td></tr>`);
    }
  }

  function exportCSV(){
    const rows = [];
    const w = toNum(wEl.value), h = toNum(hEl.value);
    const area = (w*h)/10000;

    // 입력 타이틀 사용 안 함 → 자동 제목(치수) 또는 제거 택1
    const autoTitle = `${w} × ${h} cm 환산표`;  // <-- 제목 줄 자체도 원치 않으면 이 줄과 아래 push 한 줄 삭제
    rows.push(`"${autoTitle}"`);

    rows.push(`면적(㎡),${round4(area).toFixed(4)}`);
    rows.push('');

    rows.push('평량(g/㎡),질량(g)');
    document.querySelectorAll('#tblBasisToMass tbody tr').forEach(tr=>{
      const tds = tr.querySelectorAll('td');
      rows.push(`${tds[0].textContent},${tds[1].textContent}`);
    });
    rows.push('');

    rows.push('돈(몬메),평량(g/㎡)');
    document.querySelectorAll('#tblDonToBasis tbody tr').forEach(tr=>{
      const tds = tr.querySelectorAll('td');
      rows.push(`${tds[0].textContent},${tds[1].textContent}`);
    });

    const blob = new Blob(["\uFEFF" + rows.join('\r\n')], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; 
    a.download = `${w}x${h}cm-환산표.csv`; // 파일명도 자동
    document.body.appendChild(a); 
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
  }

  $('#calc').addEventListener('click', calc);
  $('#csv').addEventListener('click', exportCSV);
  [wEl,hEl].forEach(el => el.addEventListener('keydown', e=>{
    if(e.key==='Enter') calc();
  })); // titleEl 제거

  calc();
})();
